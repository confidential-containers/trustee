use super::{EventDataParser, EventDetails};
use anyhow::Result;

pub struct EvPlatformConfigFlagsParser;

/// Parser for EV_PLATFORM_CONFIG_FLAGS.
/// Define in section 10.4.1 of <https://trustedcomputinggroup.org/wp-content/uploads/TCG_PCClient_PFP_r1p05_v23_pub.pdf>
/// This event field contents are manufacturer implementation-specific.
impl EventDataParser for EvPlatformConfigFlagsParser {
    fn parse(&self, data: Vec<u8>) -> Result<EventDetails> {
        let raw = String::from_utf8(data)
            .unwrap_or_default()
            .replace('\u{10}', " ");
        let cleaned = raw.chars().filter(|c| !c.is_control()).collect::<String>();
        Ok(EventDetails::from_string(cleaned))
    }
}

#[cfg(test)]
mod tests {
    use crate::ccel::EvPlatformConfigFlagsParser;
    use crate::ccel::EventDataParser;
    use crate::EventDetails;
    use rstest::rstest;

    #[rstest]
    #[case("414350492044415441",
    EventDetails { string: Some("ACPI DATA".to_string()), unicode_name: None, unicode_name_length: None, variable_data: None, variable_data_length: None, variable_name: None, device_paths: None, data: None }
    )]
    #[case("74645f686f62000000000000000000008014000001003800000000000900000000000000000000000000000000000000000000000000000000000000000000000000000080148000000000000300300000000000000000000000000000000000000000000700000007000000000000000000000000000040000000000300300000000000000000000000000000000000000000000000000007000000000004ff0000000000100000000000000300300000000000000000000000000000000000000000000000000007000000002004ff0000000000000200000000000300300000000000000000000000000000000000000000000000000007000000002006ff0000000000000200000000000300300000000000000000000000000000000000000000000100000003040000000000c0000000000000e03e0000000003003000000000000000000000000000000000000000000001000000030400000000000001000000ffffeefffe3f0000040008110000000070580c6aedd4f444a135dd238b6f0c8d44534454ec1000000628434c4f554448434844534454202001000000434c4448000000005b82410e2e5f53425f50485052085f4849440c41d00a06085f5354410a0b085f5549440d50434920486f74706c756720436f6e74726f6c6c6572005b01424c434b00085f43525311330a308a2b00000c01000000000000000000f0feffff3f00000ff0feffff3f00000000000000000000100000000000000079005b8050435354000e00f0feffff3f00000a105b811a5043535443504349552050434944204230454a20505345472014235043454a0a5b23424c434bffff7069505345477901684230454a5b27424c434ba40014155053434e085c2f035f53425f5043493050434e545b824ad42e5f53425f50434930085f4849440c41d00a08085f4349440c41d00a03085f41445200085f5345470b0000085f55494400085f43434101085355505000140c5f50584d00a40c0000000014375f44534d04a02a936811130a10d037c9e553357a4d9117ea4d19c3434da00a936a00a411040a0121a007936a0a05a400a411040a0100085f4352531146080a82880d00020c00000000000000000001004701f80cf80c0108871700000c0100000000000000c0ffffffe700000000000000288a2b00000c0100000000000000000000000001000000fffffffffe3f0000000000000000000000000000fe3f0000880d00010c0300000000f70c0000f80c880d00010c030000000dffff000000f379005b823453303030085f53554e0a00085f4144520c00000000141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303031085f53554e0a01085f4144520c00000100141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303032085f53554e0a02085f4144520c00000200141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303033085f53554e0a03085f4144520c00000300141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303034085f53554e0a04085f4144520c00000400141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303035085f53554e0a05085f4144520c00000500141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303036085f53554e0a06085f4144520c00000600141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303037085f53554e0a07085f4144520c00000700141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303038085f53554e0a08085f4144520c00000800141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303039085f53554e0a09085f4144520c00000900141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303130085f53554e0a0a085f4144520c00000a00141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303131085f53554e0a0b085f4144520c00000b00141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303132085f53554e0a0c085f4144520c00000c00141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303133085f53554e0a0d085f4144520c00000d00141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303134085f53554e0a0e085f4144520c00000e00141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303135085f53554e0a0f085f4144520c00000f00141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303136085f53554e0a10085f4144520c00001000141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303137085f53554e0a11085f4144520c00001100141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303138085f53554e0a12085f4144520c00001200141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303139085f53554e0a13085f4144520c00001300141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303230085f53554e0a14085f4144520c00001400141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303231085f53554e0a15085f4144520c00001500141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303232085f53554e0a16085f4144520c00001600141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303233085f53554e0a17085f4144520c00001700141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303234085f53554e0a18085f4144520c00001800141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303235085f53554e0a19085f4144520c00001900141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303236085f53554e0a1a085f4144520c00001a00141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303237085f53554e0a1b085f4144520c00001b00141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303238085f53554e0a1c085f4144520c00001c00141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303239085f53554e0a1d085f4144520c00001d00141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303330085f53554e0a1e085f4144520c00001e00141d5f454a30095c2f035f53425f504850525043454a5f53554e5f5345475b823453303331085f53554e0a1f085f4144520c00001f00141d5f454a30095c2f035f53425f504850525043454a5f53554e5f53454714472e44564e540a7b680c0100000060a00e93600c010000008653303030697b680c0200000060a00e93600c020000008653303031697b680c0400000060a00e93600c040000008653303032697b680c0800000060a00e93600c080000008653303033697b680c1000000060a00e93600c100000008653303034697b680c2000000060a00e93600c200000008653303035697b680c4000000060a00e93600c400000008653303036697b680c8000000060a00e93600c800000008653303037697b680c0001000060a00e93600c000100008653303038697b680c0002000060a00e93600c000200008653303039697b680c0004000060a00e93600c000400008653303130697b680c0008000060a00e93600c000800008653303131697b680c0010000060a00e93600c001000008653303132697b680c0020000060a00e93600c002000008653303133697b680c0040000060a00e93600c004000008653303134697b680c0080000060a00e93600c008000008653303135697b680c0000010060a00e93600c000001008653303136697b680c0000020060a00e93600c000002008653303137697b680c0000040060a00e93600c000004008653303138697b680c0000080060a00e93600c000008008653303139697b680c0000100060a00e93600c000010008653303230697b680c0000200060a00e93600c000020008653303231697b680c0000400060a00e93600c000040008653303232697b680c0000800060a00e93600c000080008653303233697b680c0000000160a00e93600c000000018653303234697b680c0000000260a00e93600c000000028653303235697b680c0000000460a00e93600c000000048653303236697b680c0000000860a00e93600c000000088653303237697b680c0000001060a00e93600c000000108653303238697b680c0000002060a00e93600c000000208653303239697b680c0000004060a00e93600c000000408653303330697b680c0000008060a00e93600c0000008086533033316914480650434e54085b235c2f035f53425f50485052424c434bffff705f5345475c2f035f53425f504850525053454744564e545c2f035f53425f50485052504349550144564e545c2f035f53425f50485052504349440a035b275c2f035f53425f50485052424c434b085f505254124322201210040cffff00000a000a000c050000001210040cffff01000a000a000c060000001210040cffff02000a000a000c070000001210040cffff03000a000a000c080000001210040cffff04000a000a000c090000001210040cffff05000a000a000c0a0000001210040cffff06000a000a000c0b0000001210040cffff07000a000a000c0c0000001210040cffff08000a000a000c050000001210040cffff09000a000a000c060000001210040cffff0a000a000a000c070000001210040cffff0b000a000a000c080000001210040cffff0c000a000a000c090000001210040cffff0d000a000a000c0a0000001210040cffff0e000a000a000c0b0000001210040cffff0f000a000a000c0c0000001210040cffff10000a000a000c050000001210040cffff11000a000a000c060000001210040cffff12000a000a000c070000001210040cffff13000a000a000c080000001210040cffff14000a000a000c090000001210040cffff15000a000a000c0a0000001210040cffff16000a000a000c0b0000001210040cffff17000a000a000c0c0000001210040cffff18000a000a000c050000001210040cffff19000a000a000c060000001210040cffff1a000a000a000c070000001210040cffff1b000a000a000c080000001210040cffff1c000a000a000c090000001210040cffff1d000a000a000c0a0000001210040cffff1e000a000a000c0b0000001210040cffff1f000a000a000c0c0000005b82312e5f53425f4d425244085f4849440c41d00c02085f55494400085f43525311110a0e86090001000000e80000100079005b8242042e5f53425f434f4d31085f4849440c41d00501085f55494400085f44444e0d434f4d3100085f43525311160a138906000301040000004701f803f80300087900085f53355f1204010a055b821a2e5f53425f50575242085f4849440c41d00c0c085f554944005b824e0f2e5f53425f4745435f085f4849440c41d00a06085f5549440d47656e65726963204576656e7420436f6e74726f6c6c657200085f43525311330a308a2b00000c01000000000000000000e0feffff3f000000e0feffff3f00000000000000000000010000000000000079005b8047445354000e00e0feffff3f00000a015b810b474453544147444154081441074553434e087047444154607b600161a0139361015c2f035f53425f435055534353434e7b600a0261a01493610a025c2f035f53425f4d4850434d53434e7b600a0461a01493610a045c2f035f53425f504850525053434e7b600a0861a01293610a08865c2e5f53425f505752420a805b824a042e5f53425f4745445f085f4849440d414350493030313300085f55494400085f435253110e0a0b89060003010d000000790014155f455654095c2f035f53425f4745435f4553434e5b8241072e5f53425f43505553085f4849440d414350493030313000085f4349440c41d00a0514064353434e085b82440443303030085f4849440d414350493030303700085f5549440a0014095f53544100a40a0f140c5f50584d00a40c00000000085f4d4154110b0a0800080000010000005b823b2e5f53425f4d485043085f4849440c41d00a06085f5549440d4d656d6f727920486f74706c756720436f6e74726f6c6c65720014064d53434e0800000000040030010000000070580c6aedd4f444a135dd238b6f0c8d4641435014010000066f434c4f554448434846414350202001000000434c44480000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000510000108000100060000000000000100000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012000040806000000000000000000000000000000000000000000000000000000000000010800010006000000000000010800010006000000000000102223c0b655000000000000040068000000000070580c6aedd4f444a135dd238b6f0c8d415049434a0000000500434c4f55444843484d414454202001000000434c4448000000000000e0fe000000000008000003000000010c00000000c0fe00000000020a0004040000000000000000000000040058000000000070580c6aedd4f444a135dd238b6f0c8d4d4346473c00000001fb434c4f55444843484d434647202001000000434c4448000000000000000000000000000000e800000000000000000000000000000000040028000000000012a46fb91f46e34b8c0dad805a497ac001000000000000000010900000000000ffff080000000000",
    EventDetails { string: Some("".to_string()), unicode_name: None, unicode_name_length: None, variable_data: None, variable_data_length: None, variable_name: None, device_paths: None, data: None }
    )]
    #[case("74645f7061796c6f61645f696e666f0000100000726f6f743d2f6465762f7664613120636f6e736f6c653d6876633020727700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
    EventDetails { string: Some("td_payload_info root=/dev/vda1 console=hvc0 rw".to_string()), unicode_name: None, unicode_name_length: None, variable_data: None, variable_data_length: None, variable_name: None, device_paths: None, data: None }
    )]
    fn test_platform_config_flags_parser(
        #[case] test_data: &str,
        #[case] expected_result: EventDetails,
    ) {
        let parser = EvPlatformConfigFlagsParser;
        let actual_result = parser.parse(hex::decode(test_data).unwrap());

        assert!(actual_result.is_ok());
        assert_eq!(actual_result.unwrap(), expected_result);
    }
}
